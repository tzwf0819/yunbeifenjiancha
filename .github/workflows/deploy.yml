name: Deploy via Docker Build on Server

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'MSSQL_Backup_Service_Simple/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Copy project files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          source: "."
          target: "/www/wwwroot/yidabackup"
          rm: true

      - name: Build and Deploy on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            set -e
            set -x

            cd /www/wwwroot/yidabackup

            CONTAINER_NAME=yida-backup-manager
            IMAGE_NAME=yida-backup-manager-image:latest

            docker build -t $IMAGE_NAME .

            docker stop $CONTAINER_NAME || echo "Container not found, continuing..."
            docker rm $CONTAINER_NAME || echo "Container not found, continuing..."

            # [云原生配置] 定义一个独立于代码目录的、用于持久化存储配置文件的路径
            PERSISTENT_CONFIG_FILE=/etc/yidabackup/config.json

            # [云原生配置] 确保这个永久目录的存在
            mkdir -p $(dirname "$PERSISTENT_CONFIG_FILE")

            # [回滚] 使用最简单的后台模式运行
            # [云原生配置] 将永久配置文件挂载到容器内部，实现配置的持久化
            docker run -d \
              --name $CONTAINER_NAME \
              --restart always \
              -p 11451:3000 \
              -v $PERSISTENT_CONFIG_FILE:/app/config.json \
              -e ADMIN_USERNAME='${{ secrets.ADMIN_USERNAME }}' \
              -e ADMIN_PASSWORD='${{ secrets.ADMIN_PASSWORD }}' \
              -e JWT_SECRET='${{ secrets.JWT_SECRET }}' \
              -e HUAWEI_OBS_AK='${{ secrets.HUAWEI_OBS_AK }}' \
              -e HUAWEI_OBS_SK='${{ secrets.HUAWEI_OBS_SK }}' \
              -e WECHAT_CORP_ID='${{ secrets.WECHAT_CORP_ID }}' \
              -e WECHAT_AGENT_ID='${{ secrets.WECHAT_AGENT_ID }}' \
              -e WECHAT_SECRET='${{ secrets.WECHAT_SECRET }}' \
              $IMAGE_NAME

            echo "Deployment finished."
