name: Deploy via Docker Build on Server

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'MSSQL_Backup_Service_Simple/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Copy project files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          source: "."
          target: "/www/wwwroot/yidabackup"
          rm: true # 在复制前清空目标目录

      - name: Build and Deploy on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            set -e # 如果任何命令失败，立即退出脚本
            set -x # 打印出所有执行的命令，便于调试

            echo "--- [DEBUG] Starting deployment on server ---"

            # 导航到工作目录
            cd /www/wwwroot/yidabackup
            echo "--- [DEBUG] Current directory: $(pwd) ---"

            echo "--- [DEBUG] Listing files in current directory: ---"
            ls -la

            # --- [核心改造-云原生配置] 从OBS拉取最新的配置文件 ---
            # 不再使用公共读的wget，改用官方工具 obsutil 进行认证下载
            OBSUTIL_DIR="obsutil_install"
            OBSUTIL_PATH="$OBSUTIL_DIR/obsutil"

            # 1. 下载并解压 obsutil (如果不存在)
            if [ ! -f "$OBSUTIL_PATH" ]; then
              echo "--- [ACTION] obsutil not found. Downloading and extracting... ---"
              mkdir -p $OBSUTIL_DIR
              wget -O $OBSUTIL_DIR/obsutil.tar.gz https://obs-community.obs.cn-north-1.myhuaweicloud.com/obsutil/lastest/obsutil_linux_amd64.tar.gz
              tar -xvf $OBSUTIL_DIR/obsutil.tar.gz -C $OBSUTIL_DIR
              # 解压后会有一个带版本的目录，我们需要找到它并把里面的工具移出来
              mv $OBSUTIL_DIR/obsutil_linux_amd64_*/obsutil $OBSUTIL_PATH
              chmod +x $OBSUTIL_PATH
            else
              echo "--- [INFO] obsutil already exists. Skipping download. ---"
            fi

            # 2. 使用AK/SK配置obsutil
            echo "--- [ACTION] Configuring obsutil with credentials... ---"
            # 注意：obs的endpoint不带https://
            OBS_ENDPOINT="obs.cn-north-4.myhuaweicloud.com"
            $OBSUTIL_PATH config -i=${{ secrets.HUAWEI_OBS_AK }} -k=${{ secrets.HUAWEI_OBS_SK }} -e=$OBS_ENDPOINT

            # 3. 使用obsutil下载配置文件
            echo "--- [ACTION] Downloading latest config from OBS using obsutil... ---"
            $OBSUTIL_PATH cp obs://yidianjicheng-backeup/config/config.json config.json --force
            echo "--- [SUCCESS] Latest config.json downloaded. ---"

            # 定义名称
            CONTAINER_NAME=yida-backup-manager
            IMAGE_NAME=yida-backup-manager-image:latest

            # 构建镜像
            echo "--- [ACTION] Building Docker image... ---"
            docker build -t $IMAGE_NAME .
            echo "--- [SUCCESS] Docker image build process completed. ---"

            # 停止并移除旧容器
            echo "--- [ACTION] Stopping and removing old container if it exists... ---"
            docker stop $CONTAINER_NAME || echo "--- [INFO] No running container to stop."
            docker rm $CONTAINER_NAME || echo "--- [INFO] No container to remove."

            # --- [核心修复] 数据持久化 --- 
            # 1. 定义永久配置文件路径 (独立于会被CI/CD擦写的代码目录)
            PERSISTENT_CONFIG_DIR=/etc/yidabackup
            PERSISTENT_CONFIG_FILE=$PERSISTENT_CONFIG_DIR/config.json

            # 2. 确保永久目录存在
            echo "--- [ACTION] Ensuring persistent config directory exists at $PERSISTENT_CONFIG_DIR ... ---"
            mkdir -p $PERSISTENT_CONFIG_DIR

            # 3. 如果永久配置文件不存在，则创建一份默认的。这仅在首次部署时发生。
            echo "--- [DEBUG] Checking for persistent config file at $PERSISTENT_CONFIG_FILE ... ---"
            if [ ! -f "$PERSISTENT_CONFIG_FILE" ]; then
              echo "--- [ACTION] Persistent config file not found. Creating a default one. ---"
              echo '{"huawei_obs":{},"wechat_app":{},"tasks":[]}' > "$PERSISTENT_CONFIG_FILE"
              echo "--- [DEBUG] Content of new persistent config.json: ---"
              cat "$PERSISTENT_CONFIG_FILE"
            else
              echo "--- [INFO] Existing persistent config file found. No changes made. ---"
            fi

            # 启动新容器 (挂载位于永久路径的配置文件)
            echo "--- [ACTION] Starting new container '$CONTAINER_NAME' from image '$IMAGE_NAME'... ---"
            docker run -d \
              --name $CONTAINER_NAME \
              --restart always \
              -p 11451:3000 \
              -v $PERSISTENT_CONFIG_FILE:/app/config.json \
              -e ADMIN_USERNAME='${{ secrets.ADMIN_USERNAME }}' \
              -e ADMIN_PASSWORD='${{ secrets.ADMIN_PASSWORD }}' \
              -e JWT_SECRET='${{ secrets.JWT_SECRET }}' \
              -e HUAWEI_OBS_AK='${{ secrets.HUAWEI_OBS_AK }}' \
              -e HUAWEI_OBS_SK='${{ secrets.HUAWEI_OBS_SK }}' \
              -e WECHAT_CORP_ID='${{ secrets.WECHAT_CORP_ID }}' \
              -e WECHAT_AGENT_ID='${{ secrets.WECHAT_AGENT_ID }}' \
              -e WECHAT_SECRET='${{ secrets.WECHAT_SECRET }}' \
              $IMAGE_NAME

            echo "--- [INFO] Waiting 5 seconds for container to initialize... ---"
            sleep 5

            echo "--- [DEBUG] Checking status of recent containers: ---"
            docker ps -a -n 10

            echo "--- [DEBUG] Displaying logs for '$CONTAINER_NAME' (if it exists): ---"
            docker logs $CONTAINER_NAME || echo "--- [INFO] Container '$CONTAINER_NAME' not found or has no logs."

            echo "--- [SUCCESS] Deployment script finished. ---"
