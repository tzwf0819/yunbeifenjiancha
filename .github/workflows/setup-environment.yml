name: Setup Server Environment (HTTP-Only)

# 允许手动触发
on:
  workflow_dispatch:
    inputs:
      server_ip:
        description: 'Your Server IP Address (domain is not ready yet)'
        required: true

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
    - name: SSH into server and run setup script
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          # 使用 sudo 执行所有需要管理员权限的命令
          set -e # 确保任何命令失败都会使工作流失败

          echo \"---> Updating package lists...\"
          sudo apt-get update

          echo \"---> Installing Docker, Nginx...\"
          sudo apt-get install -y docker.io nginx

          echo \"---> Creating project directory...\"
          sudo mkdir -p /var/www/cloudcheck
          sudo chown ${{ secrets.SERVER_USERNAME }}:${{ secrets.SERVER_USERNAME }} /var/www/cloudcheck

          echo \"---> Configuring Nginx for HTTP...\"
          # 创建一个只监听80端口的Nginx配置
          echo \"server {\n    listen 80;\n    server_name ${{ github.event.inputs.server_ip }}; # 使用IP地址或占位符域名\n\n    location / {\n        proxy_pass http://127.0.0.1:3000;\n        proxy_set_header Host \\\$host;\n        proxy_set_header X-Real-IP \\\$remote_addr;\n        proxy_set_header X-Forwarded-For \\\$proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto http;\n    }\n}\" | sudo tee /etc/nginx/sites-available/cloudcheck

          # 创建软链接启用站点（如果已存在https的配置，则先删除）
          sudo rm -f /etc/nginx/sites-enabled/cloudcheck
          sudo ln -s /etc/nginx/sites-available/cloudcheck /etc/nginx/sites-enabled/

          # 测试并重启Nginx
          sudo nginx -t
          sudo systemctl restart nginx

          echo \"\n*** Server environment setup for HTTP is complete! ***\"
          echo \"You can now access your application at http://${{ github.event.inputs.server_ip }}\" 