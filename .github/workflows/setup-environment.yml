name: Setup Server Environment (Multi-OS, v3)

# 允许手动触发
on:
  workflow_dispatch:
    inputs:
      server_ip:
        description: 'Your Server IP Address'
        required: true

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
    - name: SSH into server and run setup script
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          set -e # 确保任何命令失败都会使工作流失败

          # --- 1. 智能检测包管理器并安装软件 ---
          if command -v apt-get > /dev/null 2>&1; then
              PACKAGE_MANAGER=apt
              echo \"---> Detected Debian/Ubuntu OS. Using apt-get.\"
              sudo apt-get update -y
              sudo apt-get install -y docker.io nginx
          elif command -v yum > /dev/null 2>&1; then
              PACKAGE_MANAGER=yum
              echo \"---> Detected RHEL/CentOS OS. Using yum.\"
              sudo yum install -y docker
              echo \"---> Resetting and installing Nginx module...\"
              sudo yum module reset -y nginx
              sudo yum install -y nginx
          else
              echo \"Error: Could not find a supported package manager. Exiting.\" >&2
              exit 1
          fi
          echo \"---> Software installation complete.\"

          # --- 2. 创建目录并启动服务 ---
          echo \"---> Creating project directory...\"
          sudo mkdir -p /var/www/cloudcheck
          sudo chown ${{ secrets.SERVER_USERNAME }}:${{ secrets.SERVER_USERNAME }} /var/www/cloudcheck

          echo \"---> Starting and enabling services...\"
          sudo systemctl start docker
          sudo systemctl enable docker
          sudo systemctl start nginx
          sudo systemctl enable nginx

          # --- 3. 根据操作系统类型配置 Nginx ---
          NGINX_CONFIG_CONTENT=\"server {\n    listen 80;\n    server_name ${{ github.event.inputs.server_ip }};\n\n    location / {\n        proxy_pass http://127.0.0.1:3000;\n        proxy_set_header Host \\\$host;\n    }\n}\"

          if [ \"$PACKAGE_MANAGER\" = \"apt\" ]; then
              echo \"---> Configuring Nginx for Debian/Ubuntu...\"
              echo \"$NGINX_CONFIG_CONTENT\" | sudo tee /etc/nginx/sites-available/cloudcheck
              sudo rm -f /etc/nginx/sites-enabled/default
              if [ ! -L /etc/nginx/sites-enabled/cloudcheck ]; then
                  sudo ln -s /etc/nginx/sites-available/cloudcheck /etc/nginx/sites-enabled/
              fi
          elif [ \"$PACKAGE_MANAGER\" = \"yum\" ]; then
              echo \"---> Configuring Nginx for RHEL/CentOS...\"
              echo \"$NGINX_CONFIG_CONTENT\" | sudo tee /etc/nginx/conf.d/cloudcheck.conf
          fi

          # --- 4. 重启Nginx ---
          echo \"---> Restarting Nginx...\"
          sudo nginx -t
          sudo systemctl restart nginx

          echo \"\n*** Server environment setup for HTTP is complete! ***\"