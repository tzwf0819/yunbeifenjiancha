<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="stylesheet" href="/fonts.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>监控面板 - 备份与巡视</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="main-nav">
        <div class="logo">备份与巡视</div>
        <div class="nav-links">
            <a href="/dashboard" class="active">监控面板</a>
            <a href="/config">任务配置</a>
        </div>
    </nav>

    <div class="container dashboard-container">
        <header class="dashboard-hero panel">
            <div class="hero-text">
                <p class="eyebrow-text">REALTIME WATCH</p>
                <h1>监控面板</h1>
                <p class="page-subtitle">最近刷新时间 · {{last_updated}}</p>
            </div>
            <div class="hero-actions">
                <a class="secondary-btn" href="/config">配置任务</a>
                <button id="run-check-btn" class="primary-btn">立即巡检</button>
            </div>
        </header>

        <p id="message" class="message info" aria-live="polite">数据更新于: {{last_updated}}</p>

        {{#has_payment_warnings}}
        <section class="panel payment-panel">
            <div class="panel-heading">
                <p class="eyebrow-text">缴费提醒</p>
                <h2>需要关注的客户</h2>
            </div>
            <ul>
                {{#payment_warnings}}
                <li>{{.}}</li>
                {{/payment_warnings}}
            </ul>
        </section>
        {{/has_payment_warnings}}

        {{#error}}
        <section class="panel error-box" role="alert">
            <h3>加载错误</h3>
            <p>{{error}}</p>
        </section>
        {{/error}}

        <section class="panel results-panel">
            <div class="panel-heading">
                <div>
                    <p class="eyebrow-text">TASK OVERVIEW</p>
                    <h2>备份任务总览</h2>
                </div>
            </div>
            <div class="results-grid" id="results-grid">
                {{#grouped_results}}
                <article class="result-card" data-task-id="{{task_id}}" data-task-name="{{task_name}}" data-requires-payment="{{requires_payment}}" data-payment-due="{{payment_due_date}}">
                    <div class="result-card-header">
                        <div class="result-card-title">
                            <span class="task-name">{{task_name}}</span>
                            {{#requires_payment}}
                            <span class="payment-badge">
                                付费 · {{#payment_due_date}}{{payment_due_date}}{{/payment_due_date}}{{^payment_due_date}}未设置{{/payment_due_date}}
                            </span>
                            {{/requires_payment}}
                            {{^requires_payment}}
                            <span class="payment-badge">免审查客户</span>
                            {{/requires_payment}}
                            <span class="toggle-arrow" data-task-id="{{task_id}}" data-loaded="false">&#9654;</span>
                        </div>
                        <div class="result-card-actions">
                            <button type="button" class="emergency-trigger-btn" data-task-id="{{task_id}}" data-task-name="{{task_name}}">紧急备份</button>
                        </div>
                    </div>
                    <div class="result-card-body">
                        {{#results}}
                        <div class="status-item">
                            <div class="status-indicator">
                                <span class="status-dot {{status}}"></span>
                                <span class="db-name">{{db_name}}</span>
                            </div>
                            <div class="reason-text">{{reason}}</div>
                        </div>
                        {{/results}}

                        <div class="emergency-status-bar" style="display: none;"></div>
                        <div class="file-list-container" style="display: none;"></div>
                    </div>
                </article>
                {{/grouped_results}}

                {{^grouped_results}}
                <div class="empty-state">
                    <p class="eyebrow-text">暂无备份任务</p>
                    <h3>请先前往“任务配置”页面添加任务</h3>
                    <a href="/config" class="primary-btn">前往配置</a>
                </div>
                {{/grouped_results}}
            </div>
        </section>
    </div>

    <script src="/js/dashboard.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const runCheckBtn = document.getElementById('run-check-btn');
            const message = document.getElementById('message');
            const token = localStorage.getItem('authToken');

            if (runCheckBtn) {
                runCheckBtn.addEventListener('click', async () => {
                    if (!token) {
                        window.location.href = '/login';
                        return;
                    }

                    runCheckBtn.disabled = true;
                    runCheckBtn.textContent = '巡检中...';
                    message.textContent = '正在触发巡检，请稍候...';

                    try {
                        const response = await fetch('/api/run-check', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const result = await response.json();

                        if (response.ok) {
                            message.textContent = '巡检成功！页面即将刷新以展示最新结果...';
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        } else {
                            throw new Error(result.message || '巡检失败');
                        }

                    } catch (error) {
                        message.textContent = `操作失败: ${error.message}`;
                        runCheckBtn.disabled = false;
                        runCheckBtn.textContent = '立即巡检';
                    }
                });
            }
        });
    </script>
</body>
</html>
