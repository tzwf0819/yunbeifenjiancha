#!/bin/bash\n#\n# 服务器初始化脚本：一键安装 Docker, Nginx 并配置反向代理\n#\n# 使用方法:\n# 1. 将此脚本上传到一台全新的、基于Debian/Ubuntu的服务器。\n# 2. 赋予执行权限: chmod +x setup_server.sh\n# 3. 以root用户身份运行: ./setup_server.sh your_domain.com\n#    (请将 your_domain.com 替换为您的真实域名)\n#\n\n# --- 脚本开始 ---\n\nset -e # 如果任何命令失败，则立即退出\n\n# 检查是否以root用户运行\nif [ \"$(id -u)\" -ne 0 ]; then\n  echo \"错误：此脚本必须以 root 用户身份运行。\" >&2\n  exit 1\nfi\n\n# 检查是否提供了域名参数\nif [ -z \"$1\" ]; then\n  echo \"错误：请提供您的域名作为第一个参数。\"\n  echo \"用法: $0 your_domain.com\"\n  exit 1\nfi\n\nDOMAIN=$1\nPROJECT_DIR=\"/var/www/cloudcheck\"\n\n# --- 1. 安装基础软件 --- \necho \">>> 正在更新软件包列表并安装 Docker, Nginx...\"\napt-get update\napt-get install -y docker.io nginx\n\necho \">>> 软件安装完成。\"\n\n# --- 2. 创建项目目录 --- \necho \">>> 正在创建项目目录 ${PROJECT_DIR}...\"\nmkdir -p $PROJECT_DIR\n\n# --- 3. 配置 Nginx 反向代理 --- \necho \">>> 正在配置 Nginx 反向代理...\"\n\n# 创建Nginx配置文件\ncat > /etc/nginx/sites-available/cloudcheck << EOL\nserver {\n    listen 80;\n    server_name ${DOMAIN};\n\n    # 将所有HTTP请求重定向到HTTPS (推荐)\n    location / {\n        return 301 https://\\\$host\\\$request_uri;\n    }\n}\n\nserver {\n    listen 443 ssl;\n    server_name ${DOMAIN};\n\n    # SSL证书路径 (注意：这些路径是示例，您需要自己获取证书)\n    # 强烈推荐使用 Certbot (Let's Encrypt) 来自动获取和管理证书\n    # 例如：sudo certbot --nginx -d ${DOMAIN}\n    ssl_certificate      /etc/ssl/certs/nginx-selfsigned.crt; # 示例路径\n    ssl_certificate_key  /etc/ssl/private/nginx-selfsigned.key; # 示例路径\n\n    location / {\n        proxy_pass http://127.0.0.1:3000;\n        proxy_set_header Host \\\$host;\n        proxy_set_header X-Real-IP \\\$remote_addr;\n        proxy_set_header X-Forwarded-For \\\$proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto \\\$scheme;\n    }\n}\nEOL\n\n# 启用该站点配置\nif [ ! -L /etc/nginx/sites-enabled/cloudcheck ]; then\n    ln -s /etc/nginx/sites-available/cloudcheck /etc/nginx/sites-enabled/\nfi\n\n# 检查Nginx配置语法\nnginx -t\n\n# 重启Nginx使配置生效\nsystemctl restart nginx\n\necho \">>> Nginx 配置完成。\"\n\n# --- 4. 最终提示 --- \necho \"\n------------------------------------------------------\n服务器初始化完成！\n\n下一步操作:\n1.  确保您的域名 (${DOMAIN}) 已解析到本服务器的IP地址。\n2.  【重要】获取并配置真实的SSL证书，替换掉Nginx配置文件中的示例路径。\n    推荐使用 'sudo certbot --nginx' 命令。\n3.  在您的GitHub仓库中设置好所有Secrets。\n4.  推送代码到 'main' 分支以触发自动部署。\n------------------------------------------------------\n\"